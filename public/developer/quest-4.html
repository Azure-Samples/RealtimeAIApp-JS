<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Processing Pipeline - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-developer">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/RealtimeAIApp-JS" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Real-Time AI Integration Guide</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 4: Audio Processing Pipeline</h1>
<hr>
<p>In the heart of the real-time AI system lies the audio processing pipeline, a finely-tuned mechanism that transforms raw audio streams into actionable data and vice versa. This pipeline is responsible for capturing user voice input, converting it into a format suitable for AI processing, and then playing back AI-generated audio responses. By mastering this pipeline, developers can unlock the full potential of real-time audio communication, ensuring seamless interaction between the client and the AI system.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>Audio Worklets</strong>: How custom audio processors are implemented for low-latency audio handling in the browser.</li>
<li>üîç <strong>PCM Format Conversion</strong>: The importance of converting between Float32 and Int16 formats for compatibility with Web Audio APIs.</li>
<li>‚ö° <strong>AudioContext Lifecycle</strong>: How to manage and reuse <code class="inline-code">AudioContext</code> instances for efficient resource utilization.</li>
<li>üí° <strong>Playback Buffering</strong>: Techniques for smooth audio playback using buffer management and adaptive processing.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/player.service.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">client/src/app/core/player.service.ts</code></a></h3>
<p>The <code class="inline-code">PlayerService</code> handles audio playback in the client application. It uses an <code class="inline-code">AudioWorkletNode</code> to process and play AI-generated audio responses in real-time. This service ensures smooth playback by managing audio buffers and converting data formats as needed.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/player.service.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">init</code></a>: Initializes the audio context and registers a custom playback worklet for handling audio streams.</li>
<li><a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/player.service.ts#L62" target="_blank" rel="noopener noreferrer"><code class="inline-code">play</code></a>: Sends audio data to the playback worklet for real-time playback.</li>
<li><a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/player.service.ts#L85" target="_blank" rel="noopener noreferrer"><code class="inline-code">clear</code></a>: Clears the audio buffer to prevent playback of stale data.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async init(sampleRate: number) {
  if (this.playbackNode === null) {
    this.audioContext = new AudioContext({ sampleRate });
    const playbackWorkletBlobUrl = URL.createObjectURL(new Blob([`
      registerProcessor(&#39;playback-worklet&#39;, class PlaybackProcessor extends AudioWorkletProcessor {
          constructor() {
            super();
            this.port.onmessage = this.handleMessage.bind(this);
            this.buffer = [];
          }

          handleMessage(event) {
            if (event.data === null) {
              this.buffer = [];
              return;
            }
            this.buffer.push(...event.data);
          }

          process(inputs, outputs, parameters) {
            const output = outputs[0];
            const channel = output[0];

            if (this.buffer.length &gt; channel.length) {
              const toProcess = this.buffer.splice(0, channel.length);
              channel.set(toProcess.map((v) =&gt; v / 32768));
            } else {
              channel.set(this.buffer.map((v) =&gt; v / 32768));
              this.buffer = [];
            }

            return true;
          }
      });
    `], { type: &#39;application/javascript&#39; }));
    await this.audioContext.audioWorklet.addModule(playbackWorkletBlobUrl);
    setTimeout(() =&gt; {
      if (this.audioContext &amp;&amp; !this.initialized) {
        this.playbackNode = new AudioWorkletNode(this.audioContext, &#39;playback-worklet&#39;);
        this.playbackNode.connect(this.audioContext.destination);
        this.initialized = true;
      }
    }, 100);
  }
}
</code></pre>
<ul>
<li>This code initializes an <code class="inline-code">AudioWorkletNode</code> with a custom playback processor for handling audio streams.</li>
<li>The <code class="inline-code">playback-worklet</code> processes audio buffers, converting Int16 data to Float32 for playback compatibility.</li>
<li>The use of <code class="inline-code">setTimeout</code> ensures the worklet is fully initialized before connecting it to the audio context.</li>
<li>Buffer management prevents audio glitches by ensuring data is processed in manageable chunks.</li>
<li>This approach demonstrates the importance of modularity and reuse in audio processing.</li>
</ul>
<hr>
<pre><code class="language-typescript">async play(buffer: Int16Array) {
  if (!this.playbackNode || !this.audioContext) {
    console.warn(&#39;Audio not initialized&#39;);
    return;
  }

  if (this.audioContext.state === &#39;suspended&#39;) {
    await this.audioContext.resume();
  }

  if (buffer &amp;&amp; buffer.length &gt; 0) {
    try {
      this.playbackNode.port.postMessage(buffer);
    } 
    catch (error) {
      console.error(&#39;Failed to play audio:&#39;, error);
    }
  } 
  else {
    console.warn(&#39;Empty or invalid audio buffer received so unable to play the audio&#39;);
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/player.service.ts#L62" target="_blank" rel="noopener noreferrer"><code class="inline-code">play</code></a> method sends audio buffers to the playback worklet for real-time processing and playback.</li>
<li>The method checks the state of the <code class="inline-code">AudioContext</code> and resumes it if suspended, ensuring smooth operation.</li>
<li>Defensive programming is used to handle cases where the audio buffer is empty or invalid.</li>
<li>This method highlights how to manage asynchronous operations in real-time systems.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/recorder.service.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">client/src/app/core/recorder.service.ts</code></a></h3>
<p>The <code class="inline-code">RecorderService</code> is responsible for capturing audio input from the user&#39;s microphone and converting it into a format suitable for processing. It uses an <code class="inline-code">AudioWorkletNode</code> to perform real-time audio processing and sends the processed data to a callback function.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/recorder.service.ts#L26" target="_blank" rel="noopener noreferrer"><code class="inline-code">start</code></a>: Initializes the audio context and starts capturing audio from the microphone.</li>
<li><code class="inline-code">RecorderPCMProcessor</code>: A custom audio processor that converts Float32 audio data to Int16 format.</li>
<li><a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/recorder.service.ts#L67" target="_blank" rel="noopener noreferrer"><code class="inline-code">convertFloat32ToInt16</code></a>: A utility function for precise data conversion.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async start(stream: MediaStream) {
  if (this.isRecording) {
    console.warn(&#39;Recording already in progress. Ignoring new start call.&#39;);
    return;
  }
  this.isRecording = true;
  try {
    this.mediaStream = stream;
    if (!this.audioContext || this.audioContext.state === &#39;closed&#39;) {
      this.audioContext = new AudioContext({
        latencyHint: &#39;interactive&#39;,
        sampleRate: 24000,
      });
    }

    this.mediaStreamSource = this.audioContext.createMediaStreamSource(this.mediaStream);

    if (!this.workletBlobUrl) {
      this.workletBlobUrl = URL.createObjectURL(
        new Blob(
          [
            `
              registerProcessor(&#39;recorder-worklet&#39;, class RecorderPCMProcessor extends AudioWorkletProcessor {
                  constructor() {
                    super();
                  }
                    
                  process(inputs) {
                      const input = inputs[0];
                      if (input.length &gt; 0) {
                          const float32Buffer = input[0];
                          const int16Buffer = this.convertFloat32ToInt16(float32Buffer);
                          this.port.postMessage(int16Buffer);
                      }
                      return true;
                  }

                  convertFloat32ToInt16(float32Array) {
                      const int16Array = new Int16Array(float32Array.length);
                      for (let i = 0; i &lt; float32Array.length; i++) {
                          let val = Math.floor(float32Array[i] * 0x7fff);
                          val = Math.max(-0x8000, Math.min(0x7fff, val));
                          int16Array[i] = val;
                      }
                      return int16Array;
                  }
              });
            `,
          ],
          { type: &#39;application/javascript&#39; }
        )
      );
    }

    if (!this.workletNode) {
      await this.audioContext.audioWorklet.addModule(this.workletBlobUrl);
    }

    this.workletNode = new AudioWorkletNode(
      this.audioContext,
      &#39;recorder-worklet&#39;,
      {
        numberOfInputs: 1,
        numberOfOutputs: 1,
        channelCount: 1,
      }
    );
    
    this.workletNode.port.onmessage = (event) =&gt; {
      if (this.onDataAvailable) {
        this.onDataAvailable(event.data);
      }
    };

    this.mediaStreamSource.connect(this.workletNode);
    this.workletNode.connect(this.audioContext.destination);
  } catch (error) {
    console.error(&#39;Error starting recorder:&#39;, error);
    this.stop();
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/recorder.service.ts#L26" target="_blank" rel="noopener noreferrer"><code class="inline-code">start</code></a> method initializes the audio context and media stream source for capturing microphone input.</li>
<li>A custom <code class="inline-code">RecorderPCMProcessor</code> is registered to process audio data in real-time.</li>
<li>The processor converts Float32 audio data to Int16 format, which is more efficient for transmission and processing.</li>
<li>The code demonstrates robust error handling and resource cleanup to ensure reliability.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Use <code class="inline-code">AudioWorkletNode</code> for low-latency audio processing, as it runs on a separate thread from the main JavaScript execution.</li>
<li>Always check the state of the <code class="inline-code">AudioContext</code> before using it to avoid unexpected errors.</li>
<li>Manage audio buffers carefully to prevent glitches or data loss during playback or recording.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Modify Playback Speed</strong>: Update the <code class="inline-code">PlaybackProcessor</code> to allow variable playback speeds. Add a parameter to adjust the speed and observe how it affects the audio output.</p>
</li>
<li><p><strong>Add Noise Suppression</strong>: Enhance the <code class="inline-code">RecorderPCMProcessor</code> to include a simple noise suppression algorithm. Experiment with different thresholds to filter out background noise.</p>
</li>
<li><p><strong>Implement Audio Visualization</strong>: Use the <code class="inline-code">RecorderService</code> to capture audio data and create a real-time waveform visualization. This will help you understand audio data structures and rendering techniques.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the real-time AI application.</p>
<p>Congratulations on successfully deploying the Audio Processing Pipeline‚Äîyour signal flow is now optimized, your stack is 60% complete, and your codebase is resonating with innovation; keep pushing towards the final release! üöÄüíé‚ö°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-3.html" class="prev-quest-btn">‚Üê Previous: Quest 3</a>
        <a href="quest-5.html" class="next-quest-btn">Next: Quest 5 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>