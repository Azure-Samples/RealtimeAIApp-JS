<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Coordination Systems - Repo Adventure</title>
    <link rel="stylesheet" href="assets/theme.css">
    <link rel="stylesheet" href="../assets/shared/quest-navigator.css">
    <link rel="stylesheet" href="../assets/theme-toggle.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tk53e05gf2");
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <!-- Using minimal theme since we override all styles with our custom theme -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader for syntax highlighting
        if (window.Prism && window.Prism.plugins && window.Prism.plugins.autoloader) {
            window.Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }

        // Trigger Prism highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Prism) {
                window.Prism.highlightAll();
            }
        });
    </script>
</head>
<body class="theme-space">

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="https://github.com/danwahlin/RealtimeAIApp-JS" target="_blank" rel="noopener noreferrer" class="github-link">
                    <img src="../assets/shared/github-mark-white.svg" alt="GitHub" width="24" height="24">
                </a>
                <a href="index.html">The Galactic AI Navigator</a>
            </div>
            <div class="nav-middle">
            </div>
            <div class="nav-right">
                <a href="../index.html" class="nav-link">Change Adventure</a>
                <a href="#" class="nav-link quest-map-trigger">Quests</a>
                <button class="theme-toggle-btn" aria-label="Switch to light mode" type="button">
                    <div class="theme-toggle-slider">
                        <svg class="toggle-icon sun-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <svg class="toggle-icon moon-icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="quest-content">
    <h1>Quest 3: Stellar Coordination Systems</h1>
<hr>
<p>Aboard the <em>Galactic Navigator</em>, the crew ventures deeper into the cosmos, unraveling the mysteries of real-time AI communication. The WebSocket arrays hum with energy as they relay audio streams and text messages between the ship and distant AI personalities. Your mission is to ensure seamless operation of the Navigator‚Äôs coordination systems, enabling the crew to interact with alien languages and decode stellar signals in real time. These systems are critical for maintaining interstellar communication and supporting mission objectives.</p>
<h2>Key Takeaways</h2>
<p>After completing this quest, you will understand:</p>
<ul>
<li>üéØ <strong>WebSocket Lifecycle Management</strong>: How to establish, monitor, and gracefully close WebSocket connections.</li>
<li>üîç <strong>Reactive State Handling</strong>: How RxJS observables are used to manage connection states and message flow.</li>
<li>‚ö° <strong>Audio Streaming Pipeline</strong>: How binary audio data is captured, transmitted, and processed for real-time playback.</li>
<li>üí° <strong>Error Recovery Patterns</strong>: How defensive programming ensures system stability during WebSocket errors.</li>
</ul>
<h2>File Exploration</h2>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/web-socket.service.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">client/src/app/core/web-socket.service.ts</code></a></h3>
<p>The <em>WebSocket Service</em> acts as the Navigator‚Äôs communication array, facilitating real-time data exchange between the ship and external systems. This module manages WebSocket connections, handles incoming messages, and ensures robust error handling. It uses reactive programming techniques to monitor connection states and relay messages to other ship modules.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/web-socket.service.ts#L27" target="_blank" rel="noopener noreferrer"><code class="inline-code">connect</code></a>: Establishes a WebSocket connection and sends an initialization message to configure the session.</li>
<li><a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/web-socket.service.ts#L74" target="_blank" rel="noopener noreferrer"><code class="inline-code">send</code></a>: Transmits messages over the WebSocket to ensure real-time communication.</li>
<li><a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/web-socket.service.ts#L80" target="_blank" rel="noopener noreferrer"><code class="inline-code">close</code></a>: Gracefully shuts down the WebSocket connection, resetting internal state and observables.</li>
<li><code class="inline-code">handleError</code>: Captures WebSocket errors and propagates them for system-wide handling.</li>
<li><code class="inline-code">Symbol.asyncIterator</code>: Implements asynchronous iteration for processing queued WebSocket messages.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">connect(url: string, systemMessageType: SystemMessageType) {
  if (this.socket) this.close();

  this.socket = new WebSocket(url);
  this.socket.binaryType = &#39;arraybuffer&#39;;

  this.socket.onopen = () =&gt; {
    this._isConnected.next(true);
    this.send({
      type: &#39;text&#39;,
      data: JSON.stringify({ type: &#39;init&#39;, systemMessageType })
    });
  };
  this.socket.onclose = () =&gt; this._isConnected.next(false);
  this.socket.onerror = (event: Event) =&gt; {
    const error = (event as ErrorEvent).error || new Error(&#39;WebSocket error&#39;);
    this.handleError(error);
  };

  this.socket.onmessage = (event: MessageEvent) =&gt; {
    const message: WebSocketMessage = {
      type: event.data instanceof ArrayBuffer ? &#39;binary&#39; : &#39;text&#39;,
      data: event.data
    };
    this.messageQueue.push(message);
    this._message.next(message);
  };
}
</code></pre>
<ul>
<li>This code initializes the WebSocket connection and sends an <a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/player.service.ts#L11" target="_blank" rel="noopener noreferrer"><code class="inline-code">init</code></a> message to configure the session.</li>
<li>Reactive observables (<code class="inline-code">_isConnected</code>, <code class="inline-code">_message</code>) keep the system aware of connection states and incoming data.</li>
<li>Binary message handling supports real-time audio streaming for seamless communication.</li>
<li>Defensive error handling ensures stability when unexpected WebSocket issues occur.</li>
<li>This modular approach simplifies integration with other ship systems, such as the audio pipeline.</li>
</ul>
<hr>
<pre><code class="language-typescript">close() {
  this.socket?.close();
  this.socket = null;
  this.messageQueue = [];
  this.hasError = false;
  this._isConnected.next(false);

  // Instead of completing the subjects, recreate them
  this._errors = new Subject&lt;Error&gt;();
  this._message = new Subject&lt;WebSocketMessage&gt;();

  // Update the exposed observables to reference the new subjects
  this.errors$ = this._errors.asObservable();
  this.messages$ = this._message.asObservable();
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/web-socket.service.ts#L80" target="_blank" rel="noopener noreferrer"><code class="inline-code">close</code></a> method ensures graceful cleanup of WebSocket resources, preventing memory leaks and stale observables.</li>
<li>Recreating subjects allows safe reconnection without affecting previous listeners.</li>
<li>This approach demonstrates robust lifecycle management, critical for long-running systems.</li>
</ul>
<hr>
<h3><span class="header-prefix">File:</span> <a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/realtime-manager.service.ts" target="_blank" rel="noopener noreferrer"><code class="inline-code">client/src/app/core/realtime-manager.service.ts</code></a></h3>
<p>The <em>Real-Time Manager Service</em> serves as the Navigator‚Äôs mission coordinator, orchestrating data flow between the WebSocket service and other ship systems. It manages connection states, handles incoming messages, and supervises audio recording and playback. This service embodies the reactive programming principles that keep the Navigator‚Äôs systems responsive and reliable.</p>
<h4>Highlights</h4>
<ul>
<li><a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/web-socket.service.ts#L27" target="_blank" rel="noopener noreferrer"><code class="inline-code">connect</code></a>: Initiates the WebSocket connection and sets up necessary subscriptions for state management.</li>
<li><code class="inline-code">handleWebSocketMessage</code>: Processes incoming WebSocket messages, routing them to appropriate handlers.</li>
<li><a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/realtime-manager.service.ts#L132" target="_blank" rel="noopener noreferrer"><code class="inline-code">toggleRecording</code></a>: Manages the audio recording lifecycle based on current connection state.</li>
<li><code class="inline-code">handleWSMessage</code>: Processes specific WebSocket message types, including text, transcription, and control actions.</li>
<li><a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/realtime-manager.service.ts#L289" target="_blank" rel="noopener noreferrer"><code class="inline-code">disconnect</code></a>: Cleans up resources and resets system state when the connection is terminated.</li>
</ul>
<h4>Code</h4>
<pre><code class="language-typescript">async connect(systemMessageType: SystemMessageType) {
  if (this._connectionState.value === &#39;connected&#39;) {
    await this.disconnect();
    return;
  }

  if (!this.playerService.initialized) {
    this.playerService.init(24000);
  }

  this._connectionState.next(&#39;connecting&#39;);
  try {
    this.initializeSubscriptions();
    await this.webSocketService.connect(this.endpoint, systemMessageType);
    // Session creation will trigger &#39;connected&#39; state via subscription
  } catch (error) {
    this.logError(&#39;Connection failed:&#39;, error);
    this._connectionState.next(&#39;disconnected&#39;);
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/web-socket.service.ts#L27" target="_blank" rel="noopener noreferrer"><code class="inline-code">connect</code></a> method establishes a WebSocket connection and initializes audio playback systems.</li>
<li>Reactive state management ensures the system transitions smoothly between connection states.</li>
<li>Error handling prevents system crashes during connection failures, maintaining user experience.</li>
</ul>
<hr>
<pre><code class="language-typescript">private handleWebSocketMessage = async (message: WebSocketMessage) =&gt; {
  try {
    if (message.type === &#39;text&#39; &amp;&amp; typeof message.data === &#39;string&#39;) {
      const data = JSON.parse(message.data) as WSMessage;
      await this.handleWSMessage(data);
    } else if (
      message.type === &#39;binary&#39; &amp;&amp;
      message.data instanceof ArrayBuffer &amp;&amp;
      this.playerService.initialized &amp;&amp;
      this._isAudioOn.value
    ) {
      this.playerService.play(new Int16Array(message.data));
    }
  } catch (error) {
    this.logError(&#39;Error handling WebSocket message:&#39;, error);
  }
}
</code></pre>
<ul>
<li>This handler processes both text and binary WebSocket messages, routing them to appropriate subsystems.</li>
<li>Binary audio data is decoded and played in real-time, enabling seamless communication.</li>
<li>Error logging ensures issues are captured and can be debugged effectively.</li>
</ul>
<hr>
<pre><code class="language-typescript">async toggleRecording(constraints?: MediaStreamConstraints) { 
  try {
    const newRecordingState = await this.handleAudioRecord(this._isRecording.value, constraints);
    this._isRecording.next(newRecordingState);
    return newRecordingState;
  } catch (error) {
    this.logError(&#39;Recording error:&#39;, error);
    this._isRecording.next(false);
    return false;
  }
}
</code></pre>
<ul>
<li>The <a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/realtime-manager.service.ts#L132" target="_blank" rel="noopener noreferrer"><code class="inline-code">toggleRecording</code></a> method manages the audio recording lifecycle, adapting to the current connection state.</li>
<li>Defensive programming ensures recording is safely stopped in case of errors.</li>
<li>This approach highlights the importance of error recovery in real-time systems.</li>
</ul>
<hr>
<h2>Helpful Hints</h2>
<ul>
<li>Observe how <code class="inline-code">WebSocketService</code> uses subjects to manage message streams and state changes.</li>
<li>Study the <code class="inline-code">RealTimeManagerService</code> to understand how state observables are used for reactive UI updates.</li>
<li>Pay attention to error handling patterns in both files, which ensure system resilience under failure conditions.</li>
</ul>
<h2>Try This</h2>
<p>Challenge yourself to deepen your understanding:</p>
<ol>
<li><p><strong>Add Custom WebSocket Events</strong>: Extend the <code class="inline-code">WebSocketService</code> to handle a new event type, such as <code class="inline-code">ping</code>. Implement a handler that logs the event and sends a <code class="inline-code">pong</code> response back to the server.</p>
<ul>
<li>This will help you understand how to extend WebSocket functionality.</li>
</ul>
</li>
<li><p><strong>Trace Audio Flow</strong>: Add logging statements in <code class="inline-code">handleWebSocketMessage</code> and <a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/realtime-manager.service.ts#L132" target="_blank" rel="noopener noreferrer"><code class="inline-code">toggleRecording</code></a> to trace the complete flow of audio data from recording to playback. Observe how binary data is processed in real-time.</p>
</li>
<li><p><strong>Improve Error Handling</strong>: Modify the <a href="https://github.com/danwahlin/RealtimeAIApp-JS/blob/main/client/src/app/core/web-socket.service.ts#L27" target="_blank" rel="noopener noreferrer"><code class="inline-code">connect</code></a> method in <code class="inline-code">RealTimeManagerService</code> to retry the connection a configurable number of times before giving up. This will demonstrate how to implement robust retry mechanisms.</p>
</li>
</ol>
<hr>
<p>Excellent work! Continue to the next quest to uncover more mysteries of the Navigator‚Äôs systems.</p>
<p>Mission accomplished, cosmic navigator‚Äîyour mastery of Stellar Coordination Systems has propelled you 40% closer to the stars, shining brighter than a supernova! ‚≠êüöÄüì°</p>

</div>


      <div class="quest-navigation quest-navigation-bottom">
        <a href="quest-2.html" class="prev-quest-btn">‚Üê Previous: Quest 2</a>
        <a href="quest-4.html" class="next-quest-btn">Next: Quest 4 ‚Üí</a>
      </div>
    
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <span>Created using <a href="https://github.com/DanWahlin/ai-repo-adventures" target="_blank" rel="noopener noreferrer" class="repo-link">AI Repo Adventures</a></span>
        </div>
    </footer>
    
    <!-- Quest Navigator Script (for navbar Quests button functionality) -->
    <script src="../assets/shared/quest-navigator.js"></script>
    <!-- Theme Toggle Script (for light/dark mode toggle) -->
    <script src="../assets/theme-toggle.js"></script>
</body>
</html>